<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LLM Agent (POC) â€“ Browser Multi-Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --bg: #0b1020; --card: #11162a; --muted: #9aa4bf; }
    body { background: var(--bg); color: #e6ecff; }
    .app-card { background: var(--card); border-radius: 18px; box-shadow: 0 8px 30px rgba(0,0,0,.35); }
    .messages { height: 52vh; overflow:auto; padding-right: .5rem; }
    .msg { padding: .75rem 1rem; border-radius: 14px; margin: .35rem 0; white-space: pre-wrap; }
    .msg.user { background:#1b2342; }
    .msg.assistant { background:#18213a; }
    .msg.tool { background:#142235; font-family: ui-monospace, Menlo, Consolas, "Liberation Mono", monospace; }
    .small-muted { color: var(--muted); font-size: .85rem; }
    .tool-pill { font-size: .75rem; padding:.15rem .5rem; border:1px solid #2c3b66; border-radius:999px; color:#b9c3e8; }
    .code-input { height: 140px; font-family: ui-monospace, Menlo, Consolas, monospace; }
    .spinner { display:none; }
    .kbd { background:#0f152b; border:1px solid #2b3462; border-radius:6px; padding:.05rem .35rem; }
    .model-config textarea { height: 70px; }
    .link { color:#a9c6ff; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="m-0">ðŸ¤– LLM Agent (POC)</h3>
    <div class="small-muted">JS multi-tool agent Â· Chat + Web Search + Sandbox</div>
  </div>

  <!-- Alerts -->
  <div id="alerts"></div>

  <div class="row g-3">
    <div class="col-lg-8">
      <!-- Chat -->
      <div class="app-card p-3">
        <div class="d-flex gap-2 align-items-center mb-2">
          <span class="tool-pill">Chat</span>
          <span class="ms-auto small-muted">Press <span class="kbd">Enter</span> to send</span>
        </div>
        <div id="messages" class="messages"></div>
        <div class="d-flex mt-2 gap-2">
          <input id="userInput" class="form-control" placeholder="Ask me anythingâ€¦" />
          <button id="sendBtn" class="btn btn-primary">Send</button>
        </div>
      </div>

      <!-- JS Sandbox -->
      <div class="app-card p-3 mt-3">
        <div class="d-flex align-items-center mb-2">
          <strong class="me-2">Sandboxed JS Runner</strong>
          <span class="small-muted">Agent can call <code>run_js</code> or you can run code manually.</span>
        </div>
        <textarea id="jsCode" class="form-control code-input" spellcheck="false">
// Example: return 21 * 2;
return Array.from({length: 5}, (_,i) => i*i);
        </textarea>
        <div class="d-flex mt-2 gap-2">
          <button id="runCode" class="btn btn-outline-light btn-sm">Run Code</button>
          <div class="small small-muted">Result: <span id="codeResult">(not run)</span></div>
        </div>
      </div>
    </div>

    <!-- Config -->
    <div class="col-lg-4">
      <div class="app-card p-3">
        <div class="d-flex align-items-center mb-2">
          <strong class="me-2">Model & APIs</strong>
          <span class="spinner-border spinner-border-sm text-light ms-auto" id="busy"></span>
        </div>
        <div class="model-config">
          <div class="mb-2">
            <label class="form-label small">Provider</label>
            <select id="provider" class="form-select form-select-sm">
              <option value="openai">OpenAI or compatible</option>
              <option value="gemini">Gemini (Google AI)</option>
              <option value="aipipe">AI Pipe Proxy</option>
              <option value="localmock">Local Mock (offline demo)</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label small">Model</label>
            <input id="model" class="form-control form-control-sm" value="gpt-4o-mini" />
          </div>
          <div class="mb-2">
            <label class="form-label small">API Base URL</label>
            <input id="apiBase" class="form-control form-control-sm" value="https://api.openai.com/v1" />
            <div class="form-text">Ignored if Gemini or AI Pipe is selected</div>
          </div>
          <div class="mb-2">
            <label class="form-label small">API Key (OpenAI)</label>
            <input id="apiKey" class="form-control form-control-sm" type="password" placeholder="sk-..." />
          </div>
          <div class="mb-2">
            <label class="form-label small">Gemini Key</label>
            <input id="geminiKey" class="form-control form-control-sm" type="password" placeholder="AIza..." />
          </div>
          <div class="mb-2">
            <label class="form-label small">AI Pipe Key</label>
            <input id="aipipeKey" class="form-control form-control-sm" type="password" placeholder="Paste AI Pipe token" />
          </div>
          <div class="mb-2">
            <label class="form-label small">AI Pipe Email</label>
            <input id="aipipeEmail" class="form-control form-control-sm" type="email" placeholder="you@example.com" />
          </div>
          <hr/>
          <div class="mb-2">
            <label class="form-label small">Google Search (Custom Search JSON API)</label>
            <input id="googleKey" class="form-control form-control-sm" placeholder="Google API Key" />
            <input id="googleCx" class="form-control form-control-sm mt-1" placeholder="Search Engine ID (cx)" />
            <div class="form-text">Get from developers.google.com/custom-search</div>
          </div>
          <button id="saveCfgBtn" class="btn btn-success btn-sm w-100">Save Config</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
function showAlert(message, type = 'danger', timeout = 5000) {
  const alerts = document.getElementById('alerts');
  const el = document.createElement('div');
  el.className = `alert alert-${type} alert-dismissible fade show`;
  el.role = 'alert';
  el.innerHTML = `<div>${message}</div><button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
  alerts.appendChild(el);
  if (timeout) setTimeout(() => bootstrap.Alert.getOrCreateInstance(el).close(), timeout);
}

const cfg = {
  provider: localStorage.getItem('provider') || 'gemini',
  model: localStorage.getItem('model') || 'gpt-4o-mini',
  apiBase: localStorage.getItem('apiBase') || 'https://api.openai.com/v1',
  apiKey: localStorage.getItem('apiKey') || '',
  geminiKey: localStorage.getItem('geminiKey') || '',
  aipipeKey: localStorage.getItem('aipipeKey') || '',
  aipipeEmail: localStorage.getItem('aipipeEmail') || '',
  googleKey: localStorage.getItem('googleKey') || '',
  googleCx: localStorage.getItem('googleCx') || ''
};

function bindCfg() {
  provider.value = cfg.provider;
  model.value = cfg.model;
  apiBase.value = cfg.apiBase;
  apiKey.value = cfg.apiKey;
  geminiKey.value = cfg.geminiKey;
  aipipeKey.value = cfg.aipipeKey;
  aipipeEmail.value = cfg.aipipeEmail;
  googleKey.value = cfg.googleKey;
  googleCx.value = cfg.googleCx;
}

function saveCfg() {
  cfg.provider = provider.value; localStorage.setItem('provider', cfg.provider);
  cfg.model = model.value; localStorage.setItem('model', cfg.model);
  cfg.apiBase = apiBase.value; localStorage.setItem('apiBase', cfg.apiBase);
  cfg.apiKey = apiKey.value; localStorage.setItem('apiKey', cfg.apiKey);
  cfg.geminiKey = geminiKey.value; localStorage.setItem('geminiKey', cfg.geminiKey);
  cfg.aipipeKey = aipipeKey.value; localStorage.setItem('aipipeKey', cfg.aipipeKey);
  cfg.aipipeEmail = aipipeEmail.value; localStorage.setItem('aipipeEmail', cfg.aipipeEmail);
  cfg.googleKey = googleKey.value; localStorage.setItem('googleKey', cfg.googleKey);
  cfg.googleCx = googleCx.value; localStorage.setItem('googleCx', cfg.googleCx);
  showAlert('Configuration saved.', 'success', 2500);
}
document.getElementById('saveCfgBtn').addEventListener('click', saveCfg);

// Chat UI helpers
const messagesEl = document.getElementById('messages');
function addMsg(role, text) {
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.textContent = text;
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// LLM call
async function callLLM(messages) {
  if (cfg.provider === 'localmock') {
    return { content: 'Mock reply. Configure a real provider.' };
  }
  if (cfg.provider === 'gemini') {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${cfg.model}:generateContent?key=${cfg.geminiKey}`;
    const r = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: messages.map(m => ({ role: m.role, parts: [{ text: m.content }] }))
      })
    });
    if (!r.ok) throw new Error('Gemini API failed: ' + r.status + ' ' + await r.text());
    const data = await r.json();
    return { content: data.candidates?.[0]?.content?.parts?.[0]?.text || '(no response)' };
  }
  if (cfg.provider === 'aipipe') {
  const r = await fetch("http://localhost:5000/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      apiKey: cfg.aipipeKey,
      email: cfg.aipipeEmail,
      payload: { model: cfg.model, messages }
    })
  });

  if (!r.ok) throw new Error('AI Pipe Proxy failed: ' + r.status + ' ' + await r.text());
  const data = await r.json();
  console.log("AI Pipe response:", data);

  // Defensive parsing for both OpenRouter and AiPipe styles
  const content =
    data?.choices?.[0]?.message?.content ||
    data?.choices?.[0]?.delta?.content || // in case of streaming
    JSON.stringify(data, null, 2);

  return { content };
}

  if (!r.ok) throw new Error('OpenAI API failed: ' + r.status + ' ' + await r.text());
  const data = await r.json();
  return { content: data.choices?.[0]?.message?.content || '(no reply)' };
}

// JS Sandbox (manual)
runCode.addEventListener('click', async () => {
  try {
    const fn = new Function(jsCode.value);
    const result = await fn();
    codeResult.textContent = JSON.stringify(result);
  } catch (err) {
    codeResult.textContent = "Error: " + err.message;
  }
});

// Web Search
async function searchWeb(query, num=5){
  if (!cfg.googleKey || !cfg.googleCx) throw new Error("Google API key & cx required");
  const url = new URL('https://www.googleapis.com/customsearch/v1');
  url.searchParams.set('key', cfg.googleKey);
  url.searchParams.set('cx', cfg.googleCx);
  url.searchParams.set('q', query);
  url.searchParams.set('num', String(Math.min(10, Math.max(1, num))));
  const r = await fetch(url);
  if (!r.ok) throw new Error("Google Search API failed: " + r.status);
  const data = await r.json();
  return (data.items || []).map(it => `${it.title}\n${it.link}\n${it.snippet}`).join("\n\n");
}

// Core loop
const convo = [];
async function agentTurn(userText) {
  try {
    busy.style.display = 'inline-block';
    addMsg('user', userText);
    convo.push({ role: 'user', content: userText });

    if (/^search\s+/i.test(userText)) {
      const q = userText.replace(/^search\s+/i,'');
      const results = await searchWeb(q);
      addMsg('tool', results);
      convo.push({ role:'assistant', content: results });
      return;
    }
    if (/^js\s+/i.test(userText)) {
      const code = userText.replace(/^js\s+/i,'');
      try {
        const fn = new Function(code);
        const res = await fn();
        addMsg('tool', "Result: " + JSON.stringify(res));
        convo.push({ role:'assistant', content: String(res) });
      } catch(err) {
        addMsg('tool', "Error: " + err.message);
      }
      return;
    }

    const { content } = await callLLM(convo);
    addMsg('assistant', content);
    convo.push({ role: 'assistant', content });
  } catch (err) {
    showAlert(err.message, 'danger');
  } finally {
    busy.style.display = 'none';
  }
}

// Wire UI
sendBtn.addEventListener('click', () => {
  const t = userInput.value.trim();
  if (!t) return;
  userInput.value = '';
  agentTurn(t);
});
userInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendBtn.click(); }
});
window.addEventListener('load', bindCfg);

// greet
addMsg('assistant', 'Hi! I am a browser-based LLM agent. Ask me something. You can also try:\n- "search spaceX news"\n- "js return 6*7;"');
</script>
</body>
</html>
